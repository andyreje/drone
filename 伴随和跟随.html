<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>无人机跟随/伴随/聚焦模式演示 - 弹性布局</title>
<style>
  body, html {
    height: 100%;
    margin: 0;
    font-family: sans-serif;
    background: #f0f4f8;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 20px;
    box-sizing: border-box;
  }

  h2 {
    margin-bottom: 10px;
  }

  #modeButtons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .mode-btn { 
    padding: 10px 20px; font-size: 16px; 
    border: none; border-radius: 5px; cursor: pointer; 
    background: #ddd;
    color: #333;
    transition: background-color 0.3s ease;
  }
  .mode-btn.active, .mode-btn:hover {
    background: #0078d7;
    color: white;
  }

  #container {
    position: relative;
    flex: 1 1 auto;
    width: 90vw;
    max-width: 1000px;
    aspect-ratio: 5 / 3;
    border: 3px solid #333;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 20px;
    min-height: 300px;
  }

  .person {
    position: absolute; 
    width: 30px; height: 30px; border-radius: 50%;
    background: #4caf50; color: white; 
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: bold; cursor: grab;
    user-select: none;
  }
  .drone {
    position: absolute; 
    width: 40px; height: 40px;
    background: url('无人机.png') no-repeat center center;
    background-size: contain;
    transform-origin: center;
  }
  .fov {
    position: absolute;
    top: 50%;
    left: 100%;
    width: 0;
    height: 0;
    transform: translate(-50%, -50%) rotate(90deg);
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-top: 50px solid rgba(0, 255, 0, 0.25);
    pointer-events: none;
  }

  /* 两个控制区域横排 */
  #controlsContainer {
    display: none;
    gap: 30px;
    justify-content: center;
    flex-wrap: wrap;
    max-width: 700px;
    margin-bottom: 10px;
  }

  #controls, #focusControls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    max-width: 300px;
  }

  .control-row {
    display: flex;
    gap: 10px;
  }

  .control-btn { 
    padding: 8px 15px; font-size: 16px; 
    border: none; border-radius: 5px; 
    background: #0078d7; color: white; cursor: pointer; 
    user-select: none;
    flex: 1 1 30%;
    min-width: 60px;
    transition: background-color 0.2s ease;
  }
  .control-btn:hover {
    background: #005fa3;
  }

  @media (max-width: 600px) {
    #container {
      width: 100vw;
      max-width: none;
    }
    #controlsContainer {
      flex-direction: column;
      max-width: 100%;
      gap: 15px;
    }
    #controls, #focusControls {
      max-width: 100%;
      flex-direction: row;
      justify-content: center;
    }
    .control-row {
      flex-direction: column;
      gap: 5px;
    }
    .control-btn {
      font-size: 14px;
      min-width: 50px;
    }
  }
</style>
</head>
<body>

<h2>无人机跟随 / 伴随 / 聚焦 模式演示</h2>

<div id="modeButtons">
  <button id="followBtn" class="mode-btn active">跟随</button>
  <button id="accompanyBtn" class="mode-btn">伴随</button>
  <button id="focusBtn" class="mode-btn">聚焦</button>
</div>

<div id="container">
  <div class="person" id="person">人</div>
  <div class="drone" id="drone">
    <div class="fov"></div>
  </div>
</div>

<!-- 聚焦模式下两个按钮区域横向显示 -->
<div id="controlsContainer">
  <div id="controls">
    <div class="control-row">
      <button class="control-btn" id="btnUp">⬆ 人上</button>
    </div>
    <div class="control-row">
      <button class="control-btn" id="btnLeft">⬅ 人左</button>
      <button class="control-btn" id="btnRight">➡ 人右</button>
    </div>
    <div class="control-row">
      <button class="control-btn" id="btnDown">⬇ 人下</button>
    </div>
  </div>

  <div id="focusControls">
    <div class="control-row">
      <button class="control-btn" id="droneUp">⬆ 无人机上</button>
    </div>
    <div class="control-row">
      <button class="control-btn" id="droneLeft">⬅ 无人机绕人逆时针</button>
      <button class="control-btn" id="droneRight">➡ 无人机绕人顺时针</button>
    </div>
    <div class="control-row">
      <button class="control-btn" id="droneDown">⬇ 无人机下</button>
    </div>
  </div>
</div>

<script>
const container = document.getElementById('container');
const person = document.getElementById('person');
const drone = document.getElementById('drone');
const followBtn = document.getElementById('followBtn');
const accompanyBtn = document.getElementById('accompanyBtn');
const focusBtn = document.getElementById('focusBtn');

const controlsContainer = document.getElementById('controlsContainer');
const controls = document.getElementById('controls');
const focusControls = document.getElementById('focusControls');

let mode = "跟随";
let personPos = { x: 100, y: 100 };
let dronePos = { x: 50, y: 50 };
let dragging = false;
let keysPressed = {};
let moveIntervals = {};
let droneMoveIntervals = {};

let orbitAngle = 0;  
let orbitRadius = 100; 

let controllingDrone = false;

document.addEventListener('keydown', (e) => {
  keysPressed[e.key] = true;
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"].includes(e.key)) {
    e.preventDefault();
  }
});
document.addEventListener('keyup', (e) => {
  keysPressed[e.key] = false;
  if (["w","a","s","d"].includes(e.key)) controllingDrone = false;
  if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) controllingDrone = false;
});

person.addEventListener('mousedown', () => { dragging = true; person.style.cursor = 'grabbing'; });
document.addEventListener('mouseup', () => { dragging = false; person.style.cursor = 'grab'; });
document.addEventListener('mousemove', (e) => {
  if (dragging) {
    const rect = container.getBoundingClientRect();
    personPos.x = Math.min(rect.width - 30, Math.max(0, e.clientX - rect.left - 15));
    personPos.y = Math.min(rect.height - 30, Math.max(0, e.clientY - rect.top - 15));
  }
});

function animate() {
  moveEntities();
  moveDroneAuto();
  updateDroneOrientation();
  updatePositions();
  requestAnimationFrame(animate);
}

function moveEntities() {
  const step = 4;

  if (mode === "聚焦") {
    if (keysPressed["a"] || keysPressed["d"] || keysPressed["w"] || keysPressed["s"]) {
      controllingDrone = true;
    }

    if (controllingDrone) {
      let dx = dronePos.x - personPos.x;
      let dy = dronePos.y - personPos.y;
      orbitRadius = Math.max(50, Math.sqrt(dx*dx + dy*dy));
      orbitAngle = Math.atan2(dy, dx);

      if (keysPressed["a"]) {
        orbitAngle -= 0.05;
      }
      if (keysPressed["d"]) {
        orbitAngle += 0.05;
      }

      let newX = personPos.x + orbitRadius * Math.cos(orbitAngle);
      let newY = dronePos.y;

      if (keysPressed["w"]) {
        newY = Math.max(0, dronePos.y - step);
      }
      if (keysPressed["s"]) {
        newY = Math.min(container.clientHeight - 40, dronePos.y + step);
      }

      dronePos.x = Math.min(container.clientWidth - 40, Math.max(0, newX));
      dronePos.y = Math.min(container.clientHeight - 40, Math.max(0, newY));

      return;
    }
    if (keysPressed["ArrowUp"]) personPos.y = Math.max(0, personPos.y - step);
    if (keysPressed["ArrowDown"]) personPos.y = Math.min(container.clientHeight - 30, personPos.y + step);
    if (keysPressed["ArrowLeft"]) personPos.x = Math.max(0, personPos.x - step);
    if (keysPressed["ArrowRight"]) personPos.x = Math.min(container.clientWidth - 30, personPos.x + step);

  } else {
    if (keysPressed["ArrowUp"]) personPos.y = Math.max(0, personPos.y - step);
    if (keysPressed["ArrowDown"]) personPos.y = Math.min(container.clientHeight - 30, personPos.y + step);
    if (keysPressed["ArrowLeft"]) personPos.x = Math.max(0, personPos.x - step);
    if (keysPressed["ArrowRight"]) personPos.x = Math.min(container.clientWidth - 30, personPos.x + step);
  }
}

function moveDroneAuto() {
  if (mode === "跟随") {
    const dx = personPos.x - dronePos.x;
    const dy = personPos.y - dronePos.y;
    const distance = Math.sqrt(dx*dx + dy*dy);
    const desiredDistance = 80;
    if (distance > desiredDistance) {
      const moveX = (dx / distance) * (distance - desiredDistance) * 0.1;
      const moveY = (dy / distance) * (distance - desiredDistance) * 0.1;
      dronePos.x += moveX;
      dronePos.y += moveY;
    }
  } else if (mode === "伴随") {
    const targetX = personPos.x - 80;
    const targetY = personPos.y - 80;
    dronePos.x += (targetX - dronePos.x) * 0.08;
    dronePos.y += (targetY - dronePos.y) * 0.08;
  }
}

function updateDroneOrientation() {
  const dx = personPos.x - dronePos.x;
  const dy = personPos.y - dronePos.y;
  const angle = Math.atan2(dy, dx) * 180 / Math.PI;
  drone.style.transform = `rotate(${angle}deg)`;
}

function updatePositions() {
  personPos.x = Math.min(container.clientWidth - 30, Math.max(0, personPos.x));
  personPos.y = Math.min(container.clientHeight - 30, Math.max(0, personPos.y));

  dronePos.x = Math.min(container.clientWidth - 40, Math.max(0, dronePos.x));
  dronePos.y = Math.min(container.clientHeight - 40, Math.max(0, dronePos.y));

  person.style.left = personPos.x + 'px';
  person.style.top = personPos.y + 'px';
  drone.style.left = dronePos.x + 'px';
  drone.style.top = dronePos.y + 'px';
}

function startContinuousMove(dir, isDrone=false) {
  const step = 4;
  stopContinuousMove(dir, isDrone);
  if (isDrone) controllingDrone = true;
  const interval = setInterval(() => {
    if (isDrone) {
      if (mode === "聚焦") {
        let dx = dronePos.x - personPos.x;
        let dy = dronePos.y - personPos.y;
        orbitRadius = Math.max(50, Math.sqrt(dx*dx + dy*dy));
        orbitAngle = Math.atan2(dy, dx);

        if (dir === 'left') orbitAngle -= 0.05;
        if (dir === 'right') orbitAngle += 0.05;

        let newX = personPos.x + orbitRadius * Math.cos(orbitAngle);
        let newY = dronePos.y;

        if (dir === 'up') newY = Math.max(0, dronePos.y - step);
        if (dir === 'down') newY = Math.min(container.clientHeight - 40, dronePos.y + step);

        dronePos.x = Math.min(container.clientWidth - 40, Math.max(0, newX));
        dronePos.y = Math.min(container.clientHeight - 40, Math.max(0, newY));

      } else {
        if (dir === 'up') dronePos.y = Math.max(0, dronePos.y - step);
        if (dir === 'down') dronePos.y = Math.min(container.clientHeight - 40, dronePos.y + step);
        if (dir === 'left') dronePos.x = Math.max(0, dronePos.x - step);
        if (dir === 'right') dronePos.x = Math.min(container.clientWidth - 40, dronePos.x + step);
      }
    } else {
      if (dir === 'up') personPos.y = Math.max(0, personPos.y - step);
      if (dir === 'down') personPos.y = Math.min(container.clientHeight - 30, personPos.y + step);
      if (dir === 'left') personPos.x = Math.max(0, personPos.x - step);
      if (dir === 'right') personPos.x = Math.min(container.clientWidth - 30, personPos.x + step);
    }
  }, 30);
  if (isDrone) droneMoveIntervals[dir] = interval;
  else moveIntervals[dir] = interval;
}

function stopContinuousMove(dir, isDrone=false) {
  if (isDrone) {
    clearInterval(droneMoveIntervals[dir]);
    controllingDrone = false;
  }
  else clearInterval(moveIntervals[dir]);
}

// 绑定按钮事件（修复之前没绑定的bug）
const personDirs = ['Up', 'Down', 'Left', 'Right'];
personDirs.forEach(dir => {
  const btn = document.getElementById('btn' + dir);
  btn.addEventListener('mousedown', () => startContinuousMove(dir.toLowerCase(), false));
  btn.addEventListener('mouseup', () => stopContinuousMove(dir.toLowerCase(), false));
  btn.addEventListener('mouseleave', () => stopContinuousMove(dir.toLowerCase(), false));
});
const droneDirs = ['Up', 'Down', 'Left', 'Right'];
droneDirs.forEach(dir => {
  const btn = document.getElementById('drone' + dir);
  btn.addEventListener('mousedown', () => startContinuousMove(dir.toLowerCase(), true));
  btn.addEventListener('mouseup', () => stopContinuousMove(dir.toLowerCase(), true));
  btn.addEventListener('mouseleave', () => stopContinuousMove(dir.toLowerCase(), true));
});

followBtn.onclick = () => {
  mode = "跟随";
  followBtn.classList.add("active");
  accompanyBtn.classList.remove("active");
  focusBtn.classList.remove("active");
  controlsContainer.style.display = "none";

  let dx = dronePos.x - personPos.x;
  let dy = dronePos.y - personPos.y;
  orbitRadius = Math.sqrt(dx*dx + dy*dy);
  orbitAngle = Math.atan2(dy, dx);
};
accompanyBtn.onclick = () => {
  mode = "伴随";
  accompanyBtn.classList.add("active");
  followBtn.classList.remove("active");
  focusBtn.classList.remove("active");
  controlsContainer.style.display = "none";

  let dx = dronePos.x - personPos.x;
  let dy = dronePos.y - personPos.y;
  orbitRadius = Math.sqrt(dx*dx + dy*dy);
  orbitAngle = Math.atan2(dy, dx);
};
focusBtn.onclick = () => {
  mode = "聚焦";
  focusBtn.classList.add("active");
  followBtn.classList.remove("active");
  accompanyBtn.classList.remove("active");
  controlsContainer.style.display = "flex";

  let dx = dronePos.x - personPos.x;
  let dy = dronePos.y - personPos.y;
  orbitRadius = Math.sqrt(dx*dx + dy*dy);
  orbitAngle = Math.atan2(dy, dx);
};

updatePositions();
animate();
</script>

</body>
</html>
